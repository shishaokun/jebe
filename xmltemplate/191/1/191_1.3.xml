<?xml version="1.0" encoding="UTF-8" ?>
<Module>
       <Content id="1" view="runtime">
                <Init>
                    <![CDATA[
                        //专门针对审核系统的预览hack处理，没有见过这样bt的系统
                        if((window.top.location.href).indexOf('audit.jebe.renren.com') > 0){
                            $("#imgCreativePic")[0].style.width = '250px';
                        }
                    ]]>
                </Init>
                <![CDATA[
                    <div style="position:relative;overflow:hidden;padding:10px 0 20px;">
                        <a href='javascript:;' onclick='javascript:this.parentNode;this.parentNode.parentNode.removeChild(this.parentNode);'class="close-button-alpha" style="position:absolute;top:14px;right:4px;" title="关闭">关闭</a>
                        <ahref="{{click_url}}" id="clickUrl" target="_blank"><img  border="0" id="imgCreativePic" src="{{media_uri + mediaUri}}" alt="" /></a>
                    </div>
                ]]>
        </Content>
        <Content view="setting">
           <Init>
                <![CDATA[
				var init = function (data, query) { 					
					$('#titleEdit').rules('remove');
					$('#titleEdit').rules('add',{required:true,maxLengthCC:30,messages:{required:'请输入广告的标题',maxLengthCC:'您的标题过长，不能超过15个汉字(即30个数字或字母)'}});
					$('#clickUrl').rules('remove');
					$('#clickUrl').rules('add',{required:true, maxlength:1024, messages:{required:'请输入链接地址', maxlength:'您的链接过长，不能超过1024个字母'}});					
				   if (data && data != '') {
					data = eval('(' + data + ')');
					//为广告标题赋值
					$('#titleEdit').val(data.title);
					onEditCreativeTitle();
										
					//图片链接的URL
					$('#clickUrl').val(data.clickUrl);
					
					
					//创意素材
					$('#mediaUri').val(data.mediaUri);
					
					$('#creativePic').hide();
					$("#divRemoveUploadedFile").show();
					$("#sizeContent").hide();
						
					inputTipText();	
					$('#clickUrl').css({"color":"#000"});
										
					preview(data);
				 } else {
				 	inputTipText();
				 }
				$('#show_place_info').html('首页底部“更多新鲜事”之上');
                };
				
                window.createData = function(){
                   var result = {};						
					result.title = $('#titleEdit').val();
					result.clickUrl = $('#clickUrl').val();				
					result.mediaUri = $('#mediaUri').val();					
					$('#widget').val(obj2str(result));
                 };

               preview = function(data){					
                	if(data && typeof(data) == 'string' && data != ''){
                        data = eval('(' + data + ')');                	
					}
					
                	if(data.mediaUri) {
                		$('#imgCreativePic').attr('src', 'http://jebe.xnimg.cn' + data.mediaUri);               	                					  
    					$('#aCreativeUrl').attr('href', makeUrl(data.clickUrl));
                	}                	
                };
				uploadCreativePic = function() {
					$("#divImgUploadProgress").show();
					$("#divRemoveUploadedFile").hide();
					$("#creativePic").hide();
					$("#divErrorInfo").hide();
				    $("#divErrorInfo").text("");
				    
				    $("#mediaUri").val("");
				    var width = 540;
					var height = 80;
					var uploadURL = "";
					//判断是新bolt还是旧的bolt
					if(document.URL.indexOf("bolt.jebe.renren.com/evol") >= 0) {
						uploadURL = "/evol/creative/widgetUploadCreative.htm";
					} else {
						uploadURL = "/bolt/creative/widgetUploadCreative.htm";
					}
					uploadFile(
						{
							legalExts: ".jpg,.png",
							fileSize:"50",
							needSizeCheck: 1,
							width: width,
							height: height,
							creativePic: 'creativePic',
							uploadURL:uploadURL,
							success: function (mediaUri) {
								//原来的模板里有这句话，不知到干什么用的，暂注释掉
								//alert('http:// jebe.xnimg.cn' + mediaUri);
								$('#creativePic').val("");
								$('#creativePic').hide();
								//$('#creativePic').replaceWith('<input type="file" size="10" onchange="uploadCreativePic();" value="上传"	name="creativePic" id="creativePic" class="ad-upload-button">');
								//预览
								$('#imgCreativePic').attr('src', 'http://jebe.xnimg.cn' + mediaUri);
								
								$('#mediaUri').val(mediaUri);						   
								$('#mediaUri').parent().parent(".input-line").removeClass("error");
								$('#mediaUri').parent().siblings(".input-tips-error").hide();
								
													   
								$("#sizeContent").hide();
								
								$("#divImgUploadProgress").hide();
								$("#divRemoveUploadedFile").show();
								
								//alert("图片上传成功");

							},
							error: function (errorInfo) {
								//原来的模板里有这句话，不知到干什么用的，暂注释掉
								//$('#creativePic').replaceWith('<input type="file" size="10" onchange="uploadCreativePic();" value="上传" name="creativePic" id="creativePic" class="ad-upload-button">');
								$('#imgCreativePic').attr('src', '');
								
								$('#mediaUri').val("");
								
								$("#divImgUploadProgress").hide();							
								$('#creativePic').val("");
								$('#creativePic').show();
								$("#divErrorInfo").text(errorInfo);
								$("#divErrorInfo").show();
							}
						}
					);					
				};
				
				uploadFile = function(params) {             
					$.ajaxFileUpload
					(
						{
							url: params.uploadURL + '?legalExts=' + params.legalExts + '&fileSize=' + params.fileSize + '&needSizeCheck=' + params.needSizeCheck + '&width=' + params.width + '&height=' + params.height + '&fileElementID=' + params.creativePic,
							secureuri:false,
							fileElementId:params.creativePic,
							dataType: 'json',
							success: function (data, status) {
								if (data.result == 1) {
									if (params.success) {
										params.success(data.mediaUrl);
									}
								} else {
									if (params.error) {
										params.error(data.error);
									}
								}
							},
							error: function (data) {
								var errorInfo = "";
								if (data.responseText && data.responseText.indexOf("MaxUploadSizeExceededException") != -1) {
									errorInfo = "图片过大，不能超过3M";
								} else {
									errorInfo = "操作失败，可能网络不稳定或文件过大，请稍后重试！";
								}
								if (params.error) {
									params.error(errorInfo);
								}
							}
						}
					)
				};
				
				removeUploadedFile = function (width,height) {
					
				    $.getJSON(BOLT_DOMAIN + "/bolt/creative/removeUploadedFile.htm", { "mediaUri": $("#mediaUri").val()},
				              function(data){
				                if (data.result == 1) {
				                    $("#divRemoveUploadedFile").hide();
				                    $("#imgCreativePic").removeAttr("src");
				                    
				                    $("#mediaUri").val("");				                    							   
								    $("#imgCreativePic").attr("src","http://static.jebe.renren.com/bolt/img/example-pic-220.jpg");
								    $("#sizeContent").show();
				                    $("#creativePic").show();
				                } else {
				                    $("#divErrorInfo").text("删除已上传图片失败");
				                    $("#divErrorInfo").show();
				                }
				              });
				    $("#selfhelpIframe").remove();
				}
				
				//灰色提示文本，鼠标点击文本消失
				inputTipText = function(){   
				$("input[class*=grayTips]") //所有样式名中含有grayTips的input  
					.each(function(){  
					   //默认的提示性文本
					   var oldVal2 = "";
					   var oldVal1 = "";
					   $(this)  
					   .css({"color":"#888"})  //灰色  
					   .focus(function(){  
						if($(this).val()!=oldVal1 && $(this).val()!=oldVal2){$(this).css({"color":"#000"})}else{$(this).val("").css({"color":"#888"})}  
					   })  
					   .blur(function(){  
						    var val = $("input:radio[name='cast_type_3G']:checked").val();
						    var oldVal = (val == 1)? oldVal1 : oldVal2;
							if($(this).val()==""){ $(this).val(oldVal).css({"color":"#888"})}  
					   })  
					   .keydown(function(){$(this).css({"color":"#000"})});
					      
					});  
				}; 
				// 给url加上http前缀 
				makeUrl = function (raw) 
				{ 
					if(!raw) return ""; 
					return 'http://' + raw.replace(/http:\/\//i, '');
				};
				makeTel = function(raw)
				{
					if(!raw) return "";
					raw = raw.replace(/-/g,"");
					return 'tel:' + raw.replace(/tel:\/\//i, '');
				};
				
				onEditCreativeTitle =function() {
					replaceTitleInvalidChar();					
					calcTitleInputRemain();
				};
				calcTitleInputRemain =function() {
					var avail = 30 - $.trim($("#titleEdit").val()).getBytes();
					avail = avail > 0 ? avail : 0;
					$("#spTitleRemainWords").text(parseInt(avail/2));
				};
				onEditCreativeUrl =function() {
					var value = $.trim($("#clickUrl").val());
					if (value && !(value.indexOf("http://") != -1 || value.indexOf("https://") != -1)) {
						value = "http://" + value;
						$("#aCreativeUrl").attr('href',value);
					}else{
						$("#aCreativeUrl").attr('href',value);
					}					
				};
				replaceTitleInvalidChar =function() {
					var title = $("#titleEdit").val();
					var reg = new RegExp("[\\r]+","gm");
					if (title.search(reg) != -1) {
						title = title.replace(reg,"");
						$("#titleEdit").val(title);
					}
				}; 
			]]>
                </Init>
                <![CDATA[
                		
						<div class="input-line clearfix">
							<div class="input-label"><label>广告名称:</label></div>
							<div class="input-holder">
								<input id="titleEdit" type="text" class="input-ad-title" name="titleEdit" onblur="onEditCreativeTitle()" validate="{required:true,maxLengthCC:30,messages:{required:'请输入广告的名称',maxLengthCC:'广告名称最多不能超过15个汉字或30个字符(一个汉字算2个字符)'}}" onkeyup="onEditCreativeTitle();" />
							</div>
							<div class="input-tips">
				        		您还有<span id="spTitleRemainWords">15</span>个汉字可填
				        	</div>
						</div>						
						<div class="input-line clearfix">
							<div class="input-label"><label id="adTypeName">链接地址:</label></div>
							<div class="input-holder">
								
								<input id="clickUrl" type="text" name="clickUrl" value="" class="input-url grayTips" validate="{required:true, maxlength:1024, messages:{required:'请输入链接地址', maxlength:'您的链接过长，不能超过1024个字母'}}" onkeyup="onEditCreativeUrl()" onblur="onEditCreativeUrl()" />						
								
							</div>
							<div class="input-tips">比如：http://www.renren.com/</div>
						</div>
						<div class="input-line clearfix" >
							<div class="input-label"><label>上传图片:</label></div>
							<div class="input-holder" >
								<input id="mediaUri" name="mediaUri" value="" validate="{required:true,messages:{required:'请上传广告图片'}}" type="hidden" />								
								<div>									
									<input type="file" size="15" onchange="uploadCreativePic();" value="上传" name="creativePic" id="creativePic" class="ad-upload-button" /> 									
								</div>
								 <div class="pic-upload hide" id="divImgUploadProgress">
			                        <div class="loading-s">
			                            <img src="STATIC_DOMAIN/img/loading-s.gif">  正在上传中...
			                        </div>
			                    </div>
			                    <div class="pic-upload hide" id="divRemoveUploadedFile" >
			                        图片上传成功，若需删除请<a href="javascript:void(0)" onclick="removeUploadedFile('${width}','${height}')">点此</a>。 
			                    </div>
			                    <div class="pic-upload text-red hide" id="divErrorInfo"></div>
								
							</div>
							<div class="input-tips" id="sizeContent">尺寸540*80,小于50K.</div>							
						</div>                   
            <!--ThisIsCut-offRule-->				
				<div id="previewNormal" class="side-item-body clearfix">					
					<div class="figure">
						<a id="aCreativeUrl" class="link" href="#nogo" target="_blank"> 
							<img id="imgCreativePic" width="240" height="35" src="http://static.jebe.renren.com/bolt/img/widget/pic/960x150.jpg" />
						</a>
					</div>
				</div>				
		]]>
        </Content>
    <Content id="1" view="validate">
        <Init>
        <![CDATA[
            var init = function (data) {
					
                    if(data) {data = eval('('+data+')')}
					
                    var validateResult = ValidateUtil.newResultPack();
                    
                    return obj2str(validateResult);
            };

        ]]>
        </Init>
        <![CDATA[
			
        ]]>
    </Content>
	
	 
</Module>
